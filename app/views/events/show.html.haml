- content_for :title do
  = @event.title + " | Marche ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°"

- content_for :description do
  = truncate(@event.description, length: 100, omission: "...") # èª¬æ˜æ–‡ã‚’100æ–‡å­—ã§åˆ‡ã‚Šè©°ã‚

- content_for :canonical_url do
  = request.original_url

- content_for :og_title do
  = @event.title + " | Marcheã‚¤ãƒ™ãƒ³ãƒˆ"

- content_for :og_description do
  = truncate(@event.description, length: 100)

- if @event.images.attached? && @event.images.any?
  - og_image_url = url_for(@event.images.first.variant(resize_to_limit: [1200, 630]))
  - content_for :og_image do
    = og_image_url
  - content_for :twitter_image do
    = og_image_url

%body
  = render 'header/header' # ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ«ã‚’å‘¼ã³å‡ºã™
  
  .event-index
    .index-btn
      %p å‡ºåº—è©³ç´°ãƒšãƒ¼ã‚¸
    -# share buttons moved beside like button
  
  .event-title
    %h2= @event.title

  .event-images
    - if @event.images.attached? && @event.images.any?
      - @event.images.each do |image| # includesã§æ—¢ã«æœ€é©åŒ–æ¸ˆã¿
        .event-image
          = image_tag image.variant(resize_to_limit: [800, 600])

    - else
      .event-no-image
        = image_tag "no_image_square.jpg", class: 'event-no-image' # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’è¡¨ç¤º
  .share-buttons
    .event-like
      -# åˆ¤å®š: ç¾åœ¨ã®ãƒ“ã‚¸ã‚¿ãƒ¼ãŒæ—¢ã«ã„ã„ã­ã—ã¦ã„ã‚‹ã‹ã‚’åˆ¤å®š
      - visitor_token = session[:visitor_token]
      - existing_like = @event.event_likes.find_by(seller_id: current_seller&.id) if defined?(current_seller) && current_seller
      - existing_like ||= @event.event_likes.find_by(host_id: current_host&.id) if defined?(current_host) && current_host
      - existing_like ||= @event.event_likes.find_by(visitor_token: visitor_token) if visitor_token
      - liked = existing_like.present?
      %button.like-button{ type: 'button', data: { event_id: @event.id, liked: liked, like_id: (existing_like&.id || '') }, style: 'cursor: pointer;' }
        %span.emoji ğŸ‘
        %span.label
          - if liked
            ã„ã„ã­ã—ã¾ã—ãŸ
          - else
            ã„ã„ã­
        %span.count= @event.likes_count || 0
      
    %script{ type: 'module' }
      :plain
        (() => {
          const btn = document.querySelector('.event-like .like-button');
          if (!btn) return;
          const eventId = btn.dataset.eventId;
          const countEl = btn.querySelector('.count');
          const labelEl = btn.querySelector('.label');
          const csrf = document.querySelector('meta[name="csrf-token"]')?.content;

          function setLikedState(isLiked){
            btn.dataset.liked = isLiked ? 'true' : 'false';
            btn.classList.toggle('liked', !!isLiked);
            labelEl.textContent = isLiked ? 'ã„ã„ã­ã—ã¾ã—ãŸ' : 'ã„ã„ã­';
          }

          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const liked = btn.dataset.liked === 'true';
            try {
              if (!liked){
                const res = await fetch(`/events/${eventId}/event_likes`, {
                  method: 'POST',
                  headers: { 'Accept': 'application/json', 'X-CSRF-Token': csrf },
                  credentials: 'same-origin'
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                countEl.textContent = json.likes_count;
                btn.dataset.likeId = json.like_id || '';
                setLikedState(true);
              } else {
                const likeId = btn.dataset.likeId;
                if (!likeId) return;
                const res = await fetch(`/events/${eventId}/event_likes/${likeId}`, {
                  method: 'DELETE',
                  headers: { 'Accept': 'application/json', 'X-CSRF-Token': csrf },
                  credentials: 'same-origin'
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                countEl.textContent = json.likes_count;
                btn.dataset.likeId = '';
                setLikedState(false);
              }
            } catch (err) {
              console.error('like action failed', err);
            }
          });
        })();
    
    = link_to "https://line.me/R/msg/text/?#{CGI.escape("#{@event.title}ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ï¼ #{request.original_url}")}", target: '_blank', class: 'share-button line-share' do
      %i.fab.fa-line
      %span.label LINE
    = link_to "https://www.facebook.com/sharer/sharer.php?u=#{CGI.escape(request.original_url)}", target: '_blank', class: 'share-button facebook-share' do
      %i.fab.fa-facebook-f
      %span.label Facebook
    = link_to "https://twitter.com/intent/tweet?url=#{CGI.escape(request.original_url)}&text=#{CGI.escape("#{@event.title}ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ï¼")}", target: '_blank', class: 'share-button twitter-share' do
      %i.fab.fa-twitter
      %span.label ã‚¨ãƒƒã‚¯ã‚¹


  %table.event-details
    %tr
      %th.organizer-label
        å‡ºåº—è€…
      %td
        - if @event&.seller.present?
          = link_to @event.seller.name, seller_path(@event.seller) # seller_pathã¯é€šå¸¸IDãƒ™ãƒ¼ã‚¹
        - elsif @event&.host.present?
          -# ã“ã“ã§ãƒ›ã‚¹ãƒˆã®ã‚¹ãƒ©ãƒƒã‚°ã®æœ‰ç„¡ã‚’ç¢ºèª
          - if @event.host.slug.present?
            = link_to @event.host.name, public_host_profile_path(@event.host.slug) # â˜…ã“ã“ã‚’ä¿®æ­£â˜…
          - else
            = link_to @event.host.name, public_host_profile_path(@event.host.id) # â˜…ã“ã“ã‚’ä¿®æ­£â˜…
        - else
          å‡ºåº—è€… æœªè¨­å®š
    %tr
      %th æ¦‚è¦ã®èª¬æ˜
      %td= simple_format(@event.description)
    
    %tr
      %th é–‹å§‹æ—¥æ™‚
      %td= @event.start_time.present? ? @event.start_time.strftime('%Yå¹´%-mæœˆ%-dæ—¥ %Hæ™‚%Måˆ†') : 'æœªå®š'
    %tr
      %th çµ‚äº†æ—¥æ™‚
      %td= @event.end_time.present? ? @event.end_time.strftime('%Yå¹´%-mæœˆ%-dæ—¥ %Hæ™‚%Måˆ†') : 'æœªå®š'
    %tr
      %th éƒ½é“åºœçœŒ
      %td= @event.venue
    %tr
      %th ä½æ‰€
      %td= @event.address
    %tr
      %th å®šå“¡ã®ç›®å®‰
      %td= @event.capacity
    %tr
      %th ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é–‹å‚¬
      %td= @event.is_online ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é–‹å‚¬ã‚ã‚Š' : 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é–‹å‚¬ãªã—'
    %tr
      %th ã‚ªãƒ³ãƒ©ã‚¤ãƒ³URL
      %td= link_to @event.online_url, @event.online_url, target: "_blank" if @event&.online_url
    %tr
      %th æœ‰æ–™ã‚¤ãƒ™ãƒ³ãƒˆ
      %td= @event.is_free ? 'å‚åŠ è²»ç”¨ãŒã‹ã‹ã‚Šã¾ã™' : 'ç„¡æ–™'
    %tr
      %th å‚åŠ è²»
      %td= @event.price
    %tr
      %th ä¸»å‚¬è€…
      %td= @event.organizer.presence || 'æœªè¨­å®š'
    %tr
      %th é€£çµ¡å…ˆ
      %td= @event.contact_info
    %tr
      %th ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ
      -# %td= @event.website
      %td= link_to @event.website, @event.website, target: "_blank" if @event&.website
    -# %tr
    -#   %th å‹•ç”»URL
    -#   %td= @event.video

- if (seller_signed_in? && current_seller == @event.seller) || (host_signed_in? && current_host == @event.host)
  .edit-links.edit-links-horizontal
    - if host_signed_in? && current_host == @event.host
      = link_to 'ç·¨é›†', edit_host_event_path(@event.host.to_param, @event), class: 'operation-button'
      = button_to 'å‰Šé™¤', host_event_path(@event.host.to_param, @event), method: :delete, data: { confirm: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' }, class: 'button-delete'
    - elsif seller_signed_in? && current_seller == @event.seller
      = link_to 'ç·¨é›†', edit_event_path(@event), class: 'operation-button'
      = button_to 'å‰Šé™¤', event_path(@event), method: :delete, data: { confirm: 'æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ' }, class: 'button-delete'

= link_to 'ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã¸æˆ»ã‚‹', events_path, class: 'operation-button'

= render 'footer/footer'